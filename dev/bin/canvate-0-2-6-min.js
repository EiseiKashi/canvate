window.Canvate=function(t){"use strict";if("string"==typeof t&&null==(t=document.getElementById(t)))throw"There is no element with the 'id': "+t;window.check=!0;for(var i=0,e=["ms","moz","webkit","o"],n=0;n<e.length&&!window.requestAnimationFrame;++n)window.requestAnimationFrame=window[e[n]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[n]+"CancelAnimationFrame"]||window[e[n]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,e){var n=Date.now(),s=Math.max(0,16-(n-i)),h=window.setTimeout(function(){t(n+s)},s);return i=n+s,h}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)});var s,h,l,a,o,r,u,c,f,m,g,d,v,w,p="mouseOver",x="mouseOut",N="mouseUp",M="mouseDown",C="mouseLeave",E="click",A="drag",y="drop",T="function",I="canvas",D="2d",L="image/png",R="Anonymous",S="play",Y="playFrom",b="playUntil",_="playBetween",F=["text","size","font","color","interline","textAlign","width","height","isWordWrap"],z=0,W={},X={},B=t,O=B.getContext(D),k=function(){},P=function(t){var i,e,n=0,s=!1,h=t,l={};this.addEventListener=function(t,e,h){if(null!=t&&""!=t&&typeof e===T){null==(i=l[t])&&(i=l[t]=[]);for(var a=i.length,o=0;o<a;o++)if(e[1]==e&&e[0]==h)return;switch(l[t].push([h,e]),t){case E:case p:case x:case M:case N:case C:case C:case A:case y:n++}return s=!0}},this.removeEventListener=function(t,e,h){if(null!=t&&""!=t&&typeof e===T&&null!=(i=l[t]))for(var a=i.length,o=0;o<a;o++)if((e=i[o])[1]==e&&e[0]==h){switch(l[t].splice(o,1),t){case E:case p:case x:case M:case N:case C:case C:case A:case y:n--}return n=Math.min(n,0),s=n>0,!0}},this.emit=function(t,n){if(null!=t&&""!=t&&null!=(i=l[t])){(n=null==n||"object"!=typeof n?{}:n).type=t,n.target=h;for(var s=i.length,a=0;a<s;a++)(e=i[a])[1].apply(e[0],[n])}},this.hasMouse=function(){return s}},H=function(t,i,e,n,s,h,l){var a,o,r,u,c,f,m,g,d,v,w,p,x,N,M,C,E,A,y,T,I,D,L,R;return n-i,s-e,E=(m=n*(c=Math.cos(t)))-(g=s*(f=Math.sin(t)))+i,A=(d=n*f)+(v=s*c)+e,y=(x=(w=n+h)*c)-g+i,T=(N=w*f)+v+e,I=x-(M=(p=s+l)*f)+i,D=N+(C=p*c)+e,L=m-M+i,R=d+C+e,{minX:a=Math.min(Math.min(E,y),Math.min(I,L)),minY:o=Math.min(Math.min(A,T),Math.min(D,R)),maxX:r=Math.max(Math.max(E,y),Math.max(I,L)),maxY:u=Math.max(Math.max(A,T),Math.max(D,R)),width:Math.abs(r-a),height:Math.abs(u-o)}},q=function(t){var i=this;this.TEXT_SET="textSet",this.IMAGE_SET="imageSet",this.IMAGE_LOADED="imageLoaded",this.IMAGE_ERROR="imageError",this.CLIP_ADDED="clipAdded",this.CLIP_REMOVED="clipRemoved",this.CYCLE_END="cycleEnd",this.CYCLE_START="cycleStart",this.RENDER="render";var e="clip"+ ++z;X[e]=this,this.name=e,this.x=0,this.y=0,this.width=null,this.height=null,this.alpha=1,this.scaleX=1,this.scaleY=1,this.rotation=0,this.pivotX=0,this.pivotY=0,this.visible=!0,this.isLoop=!1,this.background=null,this.isWordWrap=!0,this.text,this.font,this.fontSize,this.fontColor,this.interline,this.textAlign,this.bounds;var h,l,a,o,r,u,c,f,m,g,d,v,w,p,x,C,E,T,B,O,k,G,U,V,j,J,K,Q,Z,$,tt,it,et,nt,st,ht,lt,at,ot,rt,ut="auto",ct=0,ft=0,mt=60,gt=1,dt=0,vt=0,wt=0,pt=0,xt=new P(this),Nt=document.createElement(I),Mt=Nt.getContext(D),Ct=[],Et=[],At=null,yt=null,Tt=!1,It=!1;this.setPosition=function(t,i){!(null==t||isNaN(t))&&(this.x=t),!(null==i||isNaN(i))&&(this.y=i)},this.setSize=function(t,i){var e=null==t||isNaN(t)&&t!=ut,n=null==i||isNaN(i)&&i!=ut;e||n||t==ut&&i==ut||(null==At&&null==yt||(t==ut&&(t=i/yt*At),i==ut&&(i=t/At*yt)),this.width=t,this.height=i)},this.setScale=function(t,i){!(null==t||isNaN(t))&&(this.scaleX=t),!(null==i||isNaN(i))&&(this.scaleY=i)},this.setPivot=function(t,i){!(null==t||isNaN(t))&&(this.pivotX=t),!(null==i||isNaN(i))&&(this.pivotY=i)},this.fitInto=function(t,i,e,n){if(null!=t&&null!=i&&!isNaN(t)&&!isNaN(i)){(null==e||isNaN(e))&&(e=0),(null==n||isNaN(n))&&(n=0),this.render(0,0);var s=this.bounds.width,h=this.bounds.height,l=Math.min(t/s,i/h),a=this.width*l,o=this.height*l;this.setSize(a,o);var r=Math.floor((t-a)/2),u=Math.floor((i-o)/2);this.x=r+this.pivotX*a+e,this.y=u+this.pivotY*o+n}},this.setAutoWidth=function(){this.setSize(ut,this.height)},this.setAutoHeight=function(){this.setSize(this.width,ut)},this.crop=function(t,e,n,s,l,a){t=null==t?dt:t,e=null==e?vt:e,n=null==n?wt:n,s=null==s?pt:s;i.width=null,i.height=null,wt=null,pt=null;var o=document.createElement(I);o.width=n,o.height=s,l=null==l||isNaN(l)?n:l,a=null==a||isNaN(a)?s:a,o.getContext(D).drawImage(h,t,e,n,s,0,0,l,a);var r=document.createElement("img");r.crossOrigin=R,r.src=o.toDataURL(L),this.setImage(o),this.setSize(l,a)},this.setImage=function(t){null!=t&&((h=t).crossOrigin=R,At=t.naturalWidth,yt=t.naturalHeight,At=null==At?t.width:At,yt=null==yt?t.height:yt,this.width=null==this.width||0==this.width?At:this.width,this.height=null==this.height||0==this.height?yt:this.height,this.setSize(this.width,this.height),d=null,wt=null==wt||0==wt?At:wt,pt=null==pt||0==pt?yt:pt,this.setCycle(dt,vt,wt,pt),Yt(i.IMAGE_SET,{image:t}))},this.setCycle=function(t,i,e,n,s,l,a){if(x=dt=null==t||isNaN(t)?dt:t,C=vt=null==i||isNaN(i)?vt:i,E=wt=null==e||isNaN(e)?wt:e,T=pt=null==n||isNaN(n)?pt:n,l=null==l||isNaN(l)?0:l,a=null==a||isNaN(a)?0:a,null==s||isNaN(s)){var o=Math.floor(h.width/E),r=Math.floor(h.height/T);s=gt=o*r}for(0==gt&&(gt=1),Et.length=0,B=0;B<gt;B++)if(E*B,Et.push({x:x,y:C,width:E,height:T}),(x+=E)>=At&&(x=0,C+=T,vt>yt))throw new Error("The total frames is out of bound");1<gt&&this.setSize(E,ut)},this.setImageById=function(t){var i=document.getElementById(t);if(i.crossOrigin=R,null==i)throw"There is no element with the id: "+t;return this.setImage(i),i},this.loadImage=function(t,e){var n=new Image;n.onload=function(){i.setImage(n),Yt(i.IMAGE_LOADED,{image:n,src:t})},n.onerror=function(e){Yt(i.IMAGE_ERROR,{src:t})};var s=e?"?"+(new Date).getTime():"";n.crossOrigin=R,n.src=t+s},this.setMask=function(){Tt=!0},this.unsetMask=function(){Tt=!1},this.setBackground=function(t){this.background=t},this.setRect=function(t,e,n){if(null!=t&&null!=e&&!isNaN(t)&&!isNaN(e)){i.width=null,i.height=null,wt=null,pt=null;var s=document.createElement(I);s.width=t,s.height=e;var h=s.getContext(D);h.fillStyle=n,h.fillRect(0,0,t,e);var l=document.createElement("img");l.crossOrigin=R,l.src=s.toDataURL(L),this.setImage(s)}},this.setText=function(t,i,e,s,h,l,a,o){i=null==i?this.fontSize:i,e=null==e?this.font:e,s=null==s?this.fontColor:s,l=null==l?this.width:l,a=null==a?this.height:a,o=null==o?this.interline:o;var r=new function(t,i,e,s,h,l,a,o){var r=this;this.text=t,this.size=null==i||isNaN(i)?12:i,this.font=null==e?"sans-serif":e,this.color=null==s?"black":s,this.width=null==l||isNaN(l)?null:l,this.height=null==a||isNaN(a)?null:a,this.interline=null==o||isNaN(o)?1.313:o,this.textAlign=null==h?"left":h,this.isWordWrap=!0,this.naturalWidth,this.naturalHeight;var u,c,f,m,g,d,v,w,p,x,N=document.createElement(I),M=N.getContext(D),C=!1,E=[],A=[];this.getCanvas=function(){var t=!0,i=F.length;for(o=0;o<i;o++)m=r[F[o]],E[o]!=m&&(t=!1),E[o]=m;if(t&&C)return N;M.textAlign=r.textAlign,M.textBaseline="top",M.fillStyle=r.color,M.font=r.size+"px "+r.font;var e,s=r.text;if(p=null==this.width?Math.ceil(M.measureText(s).width):this.width,x=null==this.height?r.interline*r.size:this.height,this.isWordWrap){f=r.interline*r.size,A.length=0;var h=0,l=Math.ceil(M.measureText(s).width);c=l;for(var a=!1;l>p&&(g=s.indexOf("-"),d=s.indexOf(" "),g>0||d>0);)v=-1==g?d:-1==d?g:Mat.min(g,d),e=s.slice(0,v+(d==v?1:0)),w=s.slice(v+1),A.push(e),h+=f,a||(a=!0,c=0),l=Math.ceil(M.measureText(w).width),c=Math.max(Math.ceil(M.measureText(e).width),c),s=w;A.push(s)}switch(u=h+f,N.width=this.naturalWidth=p,N.height=this.naturalHeight=x,M.textAlign=r.textAlign,M.textBaseline="top",M.fillStyle=r.color,M.font=r.size+"px "+r.font,i=A.length,h=0,r.textAlign){case"left":n=0;break;case"center":n=N.width/2;break;case"right":n=N.width}for(var o=0;o<i;o++)e=A[o],M.fillText(e,n,h),h+=f;return C=t,N},this.getHeight=function(){return u},this.getWidth=function(){return c}}(t,i,e,s,h=null==h?this.textAlign:h,l,a,o);this.setImage(r.getCanvas()),this.text=r.text,this.fontSize=r.size,this.font=r.font,this.fontColor=r.color,this.interline=r.interline,this.textAlign=r.textAlign,d=r},this.textToImage=function(){if(null==d)return null;v=!0},this.getTextWidth=function(){return null==d?null:d.getWidth()},this.getTextHeight=function(){return null==d?null:d.getHeight()},this.fitToText=function(){null!=d&&(d.getCanvas(),this.width=d.getWidth(),this.height=d.getHeight())},this.getId=function(){return e},this.getNewClip=function(t){return new q(t)},this.addNewClip=function(t){var i=new q(t);return this.addClip(i),i},this.getClipAt=function(t){return Ct[t]},this.addClip=function(t){null!=t&&t!=this&&this.addClipAt(t,Ct.length)},this.addClipAt=function(t,e){if(null!=t&&t!=this&&!isNaN(e)){var n=t.getParent();null!=n&&n.removeClip(t),Ct.splice(e,0,t),W[t.getId()]=this,Yt(i.CLIP_ADDED,{parent:n})}},this.removeClip=function(t){if(null!=t&&t!=this)for(var i=Ct.length,e=0;e<i;e++)if(Ct[e]==t)return this.removeClipAt(e)},this.removeClipAt=function(t){if(!isNaN(t||t<0||!(t<Ct.length))){var e=Ct.splice(t,1)[0],n=W[e.getId()];return W[e.getId()]=null,Yt(i.CLIP_REMOVED,{parent:n}),e}},this.removeAllClips=function(){for(;Ct.length>0;)this.removeClipAt(0)},this.getTotalClip=function(){return Ct.length},this.setDepth=function(t,i){if(null!=t&&t!=this&&!isNaN(i)){i=Math.max(i,0);for(var e=Ct.length,n=0;n<e;n++)Ct[n]==t&&Ct.splice(i,0,Ct.splice(n,1)[0])}},this.swapClips=function(t,i){if(null!=t&&null!=i){for(var e,n,s,h=Ct.length;--h>-1;)t==(s=Ct[h])&&(e=h),i==s&&(n=h);if(null!=e&&null!=n){var l=Ct[e],a=Ct[n];Ct[e]=a,Ct[n]=l}}},this.toFront=function(t){null!=t&&this.setDepth(t,Ct.length-1)},this.toBack=function(t){null!=t&&this.setDepth(t,0)},this.getParent=function(){return W[e]},this.getClipByProp=function(t,i){return getClipListByProp(t,i)[0]},this.getClipListByProp=function(t,i){for(var e=Ct.length,n=[],s=0;s<e;s++){var h;(h=Ct[s])[t]==i&&n.push[h]}return n};var Dt=function(t){ct=ft>=t?-1:1,c=t},Lt=function(t){if(isNaN(t))throw new Error("The frame must be an integer and is: "+t);return O=(O=(O=t-1)<0?0:O)>=Et.length?Et.length-1:O};this.play=function(){var t=f;m=Date.now(),O=Et.length-1,g=S,u=0,Dt(O),Yt(i.CYCLE_START,{frame:t,action:g})},this.playFrom=function(t){var e=f;m=Date.now(),O=Lt(t),f=O+1,ft=O,u=O,g=Y,Dt(Et.length-1),Yt(i.CYCLE_START,{frame:e,action:g})},this.playUntil=function(t){var e=f;m=Date.now(),O=Lt(t),u=ft,g=b,Dt(O),Yt(i.CYCLE_START,{frame:e,action:g})},this.playBetween=function(t,e){var n=f;m=Date.now(),k=Lt(t),G=Lt(e),ft=k,u=k,f=k+1,g=_,Dt(G),Yt(i.CYCLE_START,{frame:n,action:g})},this.stop=function(){var t=f;m=Date.now(),f=(O=ft)+1,c=O,g="stop",f=null,g=null,Yt(i.CYCLE_START,{frame:t,action:g})},this.stopAt=function(t){var e=f;m=Date.now(),O=Lt(t),f=O+1,ft=Math.max(Math.min(O,Et.length),0),c=O,g="stopAt",f=null,g=null,Yt(i.CYCLE_START,{frame:e,action:g})},this.nextFrame=function(){if(ft>=Et.length-1){if(!this.isLoop)return;ft=0}var t=f;m=Date.now(),O=Math.max(Math.min(ft+1,Et.length),0),f=O+1,ft=O,c=O,g="nextFrame",Yt(i.CYCLE_START,{frame:t,action:g})},this.prevFrame=function(){if(0==ft){if(!this.isLoop)return;ft=Et.length-1}var t=f;m=Date.now(),O=Math.max(Math.min(ft-1,Et.length),0),f=O+1,ft=O,c=O,g="prevFrame",Yt(i.CYCLE_START,{frame:t,action:g})},this.getTotalFrames=function(){return gt},this.getCurrentFrame=function(){return f},this.setFrameRate=function(t){null==t||isNaN(t)||(mt=t)},this.getFrameRate=function(){return mt};var Rt=function(t){It=!0,w=l-i.x,p=a-i.y,Yt(A)},St=function(t){It=!1,Yt(y)};this.startDrag=function(){this.addEventListener(M,Rt,this),this.addEventListener(N,St,this)},this.stopDrag=function(){It=!1,this.removeEventListener(M,Rt,this),this.removeEventListener(N,St,this)},this.emitMouseEvent=function(t,e,n){s==this&&Yt(t,{x:e-i.x,y:n-i.y})},this.hasMouse=function(){return r},this.addEventListener=function(t,i,e){xt.addEventListener(t,i,e),r=xt.hasMouse()},this.removeEventListener=function(t,i,e){xt.removeEventListener(t,i,e),r=xt.hasMouse()},this.hasButton=function(){return _hasButton},this.debug=function(){};var Yt=function(t,i){xt.emit(t,i)};this.render=function(t,e){if(l=t,a=e,0==Ct.length&&null==h||0==this.visible)return{};V=Et[U=ft];try{dt=V.x,vt=V.y,wt=V.width,pt=V.height}catch(t){this.name}if(f=U+1,(j=Date.now())-m>=1e3/mt)if(m=j,ft!=c)ft+=ct,ft=Math.max(0,ft);else if(0!=ct){if(this.isLoop)switch(g){case _:case b:case Y:ft=u;break;case S:ft=0}else ct=0;null!=g&&Yt(i.CYCLE_END,{frame:f,action:g})}var n,s,x,N,M;null!=d&&(d.text=this.text,d.size=this.fontSize,d.font=this.font,d.color=this.fontColor,d.interline=this.interline,d.textAlign=this.textAlign,d.isWordWrap=this.isWordWrap,d.width=this.width,d.height=this.height,h=d.getCanvas(),At=wt=this.width,yt=pt=this.height),It&&(this.x=l-w,this.y=a-p),J=this.x,K=this.y,at=this.scaleX,ot=this.scaleY,Q=this.width*at,Z=this.height*ot,nt=this.pivotX*Q*at,st=this.pivotY*Z*ot,$=dt,tt=vt,it=wt,et=pt,lt=this.rotation*Math.PI/180;var C,E,A,y=[];n=null,s=null,x=null,N=null,null!=h&&(n=(M=H(0,J,K,-nt,-st,Q,Z)).minX,s=M.minY,x=M.maxX,N=M.maxY),null!=h?(C=Q/At,E=Z/yt,C=isNaN(C)?1:C,E=isNaN(E)?1:E):(C=1,E=1),C*=at,E*=ot,o=null;var T=J-nt,I=K-st,D=Ct.length;for(U=0;U<D;U++)ht=Ct[U],rt=ht.render(t-i.x,e-i.y,!1),null!=rt.inner&&(A=rt.bounds,y.push({canvas:rt.inner,x:A.minX,y:A.minY}),Boolean(rt.clipMouse)&&(o=rt.clipMouse),null!=n?(n=Math.min((A.minX+T)*C,n),s=Math.min((A.minY+I)*E,s),x=Math.max((A.maxX+T)*C,x),N=Math.max((A.maxY+I)*E,N)):(n=(A.minX+T)*C,s=(A.minY+I)*E,x=(A.maxX+T)*C,N=(A.maxY+I)*E));var L=Math.abs(x-n),R=Math.abs(N-s);n=(M=H(lt,J,K,-(J-n),-(K-s),L,R)).minX,s=M.minY,x=M.maxX,N=M.maxY,Nt.width=M.width,Nt.height=M.height,Mt.save(),Mt.globalAlpha=i.alpha;var F,z,W,X,B,O,k=at<0?-Nt.width:0,P=ot<0?-Nt.height:0,q=J-n+k,G=K-s+P;Mt.translate(q,G),Mt.rotate(lt),at=at<0?-1:1,ot=ot<0?-1:1,Mt.scale(at,ot),null!=i.background&&(Mt.fillStyle=i.background,Mt.fillRect(0,0,Nt.width,Nt.height)),null!=h&&0!=h.width&&0!=h.height?Mt.drawImage(h,$,tt,it,et,-nt,-st,Q,Z):(i.width=L,i.height=R,At=L,yt=R,it=L,et=R),Tt&&(Mt.globalCompositeOperation="source-in");D=y.length;for(var ut=0;ut<D;ut++)null!=(O=y[ut])&&0!=O.canvas.width&&0!=O.canvas.height&&(F=O.canvas,z=(O.x-nt)*C,W=(O.y-st)*E,X=F.width*C,B=F.height*E,Mt.drawImage(O.canvas,z,W,X,B));if(Mt.globalCompositeOperation="source-over",r){var gt=Mt.getImageData(t-n,e-s,1,1).data;gt[3]>0&&(o=i)}Mt.restore(),Nt.id=i.name;var xt={inner:Nt,clipMouse:o,bounds:M,x:n,y:s};return Yt(i.RENDER,{}),v&&(v=!1,this.setImage(h)),this.bounds=M,xt},this.setImage(t)},G=function(){void 0!=l&&void 0!=a&&(g="default",null!=f&&f.hasMouse()?(g="pointer",f!=c&&(U(),c=f,s=f,null!=f&&f.emitMouseEvent(p,l,a),s=null)):U(),B.style.cursor=g)},U=function(t){Boolean(c)&&c.hasMouse()&&(s=c,c.emitMouseEvent(x,l,a),t&&c.emitMouseEvent(N,l,a),c=null,f=null,s=null)},V=function(){f=null,B.width=m.width,B.height=m.height,h.width=m.width,h.height=m.height,v=m.render(l,a),d=v.inner,Boolean(d)&&0!=d.width&&0!=d.height&&(O.drawImage(d,v.x,v.y),null!=(w=v.clipMouse)&&(f=w)),k(),requestAnimationFrame(V)};return function(){B.width=B.width,B.height=B.height,h=B.cloneNode(),h.getContext(D),h.width=B.width,h.height=B.height,(m=new q).name="canvateStage",m.setImage(B),delete m.setImage,delete m.setText,delete m.setImageById,delete m.loadImage,B.onmousemove=function(t){t.preventDefault(),u=B.getBoundingClientRect(),o=t.clientX,r=t.clientY,l=(o-u.left)*(B.width/u.width),a=(r-u.top)*(B.width/u.width),k=G},B.onclick=function(t){t.preventDefault(),null!=f&&f.hasMouse()&&(s=f,f.emitMouseEvent(E,l,a),s=null)},B.onmousedown=function(t){t.preventDefault(),null!=f&&f.hasMouse()&&(s=f,f.emitMouseEvent(M,l,a),s=null)},B.onmouseup=function(t){t.preventDefault(),null!=f&&f.hasMouse()&&(s=f,f.emitMouseEvent(N,l,a),s=null)},window.onmouseleave=function(t){U(!0)},document.onmouseleave=B.onmouseleave=function(t){U(!0),k=function(){}};new P(B);V()}(),m};